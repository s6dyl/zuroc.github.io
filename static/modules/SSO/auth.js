define('SSO/auth', function(require, exports, module){ // Generated by CoffeeScript 1.8.0
var modal;

modal = function(html, color, id, callback) {
  return $.modal(html, {
    dimmerClassName: 'form ' + color
  }, id, callback);
};

$.SSO.auth = {
  "new": function() {
    var self;
    return self = modal("<style>#SsoAuthLogin .login {\n  margin-top: 3em;\n  color: #9C847F; }\n\n  #SsoAuthLogin .login a {\n    color: #9C847F; }\n\n    #SsoAuthLogin {\n      height: 100%; }\n\n      #SsoAuthLogin .login a:hover {\n        color: #fff;\n        padding-bottom: 5px;\n        border-bottom: 2px solid #fff; }\n\n        #SsoAuthLogin .content {\n          max-width: 600px;\n          margin: auto; }</style><i class=\"close icon\"></i><form ms-submit=\"submit\" id=\"SsoAuthLogin\"><div class=\"vc2\"><div class=\"vc1\"><div class=\"content\"><div class=\"description ui form\"><div class=\"field\"><input spellcheck=\"false\" autocomplete=\"off\" ms-duplex=\"o.username\" name=\"username\"><label>昵称</label></div><div class=\"field\"><input spellcheck=\"false\" autocomplete=\"off\" ms-duplex=\"o.mobilePhoneNumber\" name=\"mobilePhoneNumber\"><label>手机</label></div><div class=\"field\"><input spellcheck=\"false\" autocomplete=\"off\" ms-duplex=\"o.email\" name=\"email\"><label>邮箱</label></div><div class=\"field\"><input autocomplete=\"off\" ms-duplex=\"o.password\" type=\"password\" ms-duplex=\"o.password\" name=\"password\"><label>密码</label></div><div class=\"one fluid ui inverted buttons\"><button type=\"submit\" class=\"ui green ok basic inverted button\">创建账号</button></div><div class=\"login\">已经注册 ？<a href=\"javascript:$$('SSO/auth.login');void(0)\">点此登录</a></div></div></div></div></div><input type=\"submit\" class=\"hideSubmit\"></form>", "red", "ssoAuthNew", function(elem) {
      var error_tip, m;
      error_tip = $.error_tip(elem);
      return m = {
        o: {
          email: "",
          mobilePhoneNumber: "",
          username: "",
          password: ""
        },
        submit: function() {
          AV.Cloud.run("SSO.auth.new", m.o, {
            success: function(user) {
              return AV.User.logIn(m.o.email, m.o.password, {
                success: function(user) {
                  return $.modal_alert("<h1><p>账号创建成功。</p><p>开始一段新的旅程吧！</p></h1>", {
                    onApprove: function() {
                      return location.reload();
                    }
                  });
                }
              });
            },
            fail: function(error) {
              return error_tip.set(error);
            }
          });
          return false;
        }
      };
    });
  },
  login: function(url) {
    return require_async("/lib/store", function() {
      var self;
      return self = modal("<style>#SsoAuthLogin .login {\n  margin-top: 3em;\n  color: #9C847F; }\n\n  #SsoAuthLogin .login a {\n    color: #9C847F; }\n\n    #SsoAuthLogin {\n      height: 100%; }\n\n      #SsoAuthLogin .login a:hover {\n        color: #fff;\n        padding-bottom: 5px;\n        border-bottom: 2px solid #fff; }\n\n        #SsoAuthLogin .content {\n          max-width: 600px;\n          margin: auto; }</style><i class=\"close icon\"></i><form ms-submit=\"submit\" id=\"SsoAuthLogin\"><div class=\"vc2\"><div class=\"vc1\"><div class=\"content\"><div class=\"description ui form\"><div class=\"field\"><input spellcheck=\"false\" autocomplete=\"off\" ms-duplex=\"o.account\" name=\"account\" placeholder=\"请输入您的 昵称 或 手机 或 邮箱\"><label>账号</label></div><div class=\"field\"><input autocomplete=\"off\" ms-duplex=\"o.password\" type=\"password\" ms-duplex=\"o.password\" name=\"password\"><label>密码</label></div><div class=\"one fluid ui inverted buttons\"><button type=\"submit\" class=\"ui green ok basic inverted button\">开始使用</button></div><div class=\"login\">没有账号 ？<a href=\"javascript:$$('SSO/auth.new');void(0)\">点此注册</a></div></div></div></div></div><input type=\"submit\" class=\"hideSubmit\"></form>", "green", "ssoAuthLogin", function(elem) {
        var error_tip, m;
        error_tip = $.error_tip(elem);
        avalon.nextTick(function() {
          return elem.find('[name=account]').focus().select();
        });
        return m = {
          o: {
            account: store.get('username') || '',
            password: ""
          },
          submit: function() {
            var account, error, login;
            account = m.o.account;
            if (isNaN(account - 0)) {
              login = AV.User.logIn;
            } else {
              login = AV.User.logInWithMobilePhone;
            }
            error = {};
            if (!account) {
              error.account = "";
            }
            if (!m.o.password) {
              error.password = "";
            }
            if (!error_tip.set(error)) {
              login(account, m.o.password, {
                success: function(user) {
                  store.set('username', user.getUsername());
                  return location.reload();
                },
                error: function(user, _error) {
                  if (_error.code === 211) {
                    error.account = "该账号不存在";
                  } else if (_error.code === 210) {
                    error.password = "密码错误。忘记密码了？<a href=\"javascript:$$('SSO.auth.reset_password', '" + m.o.account + "');void(0)\">点此找回。</a>";
                  }
                  return error_tip.set(error);
                }
              });
            }
            return false;
          }
        };
      });
    });
  }
};

//# sourceMappingURL=auth.js.map
 
});